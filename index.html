<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Celetalk</title>
        <link rel="stylesheet" type="text/css" href="static/style.css" />
    </head>
    <body>
        <h1>Talk with a Celebrity</h1>
        <video id="video" autoplay hidden></video>
        <canvas id="video-out"></canvas>
        <div class="controls">
            <button>Call</button>
            <button>Hang Up</button>
        </div>
        <canvas id="face-canvas"></canvas>
    </body>
    <footer>
        <script async type="text/javascript" src="wasm/face_replace.js"></script>
        <script type='text/javascript'>
         let video = document.querySelector("#video");
         let videoOut = document.querySelector("#video-out");
         let faceCanvas = document.querySelector("#face-canvas");
         let con = videoOut.getContext('2d');
         let faceCon = faceCanvas.getContext('2d');
         let isStreaming = false;
         let width = 600;
         let height = 420;

         video.addEventListener('canplay', (e) => {
             if (!isStreaming) {
                 // videoWidth isn't always set correctly in all browsers
                 if (video.videoWidth > 0) {
                     height = video.videoHeight / (video.videoWidth / width);
                 }

                 videoOut.setAttribute('width', width);
                 videoOut.setAttribute('height', height);

                 // Reverse the canvas image
                 con.translate(width, 0);
                 con.scale(-1, 1);
                 isStreaming = true;
             }
         }, false);


         video.addEventListener('play', () => {
             // Every 33 milliseconds copy the video image to the canvas
             setInterval(()  => {
                 if (video.paused || video.ended) {
                     return;
                 }

                 con.fillRect(0, 0, width, height);
                 con.drawImage(video, 0, 0, width, height);
                 transformFace();
             }, 33);
         }, false);

         navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
             const url = window.URL || window.webkitURL;
             video.src = url ? url.createObjectURL(stream) : stream;
             video.play();

             //             video.srcObject = stream;
         }).catch((error) => {
             console.log("Error getting video.")
         });

         /* function handleVideo(stream) {

          *     const track = stream.getVideoTracks()[0];
          *     imageCapture = new ImageCapture(track);
          *     imageCapture.grabFrame().then(frame => console.log(frame));
          * }*/

         function transformFace() {
             var imageData = con.getImageData(0, 0, width, height);
             //             console.log(imageData.data);
         }
        </script>
    </footer>
</html>
